# SysTTS Human Test Plan

Generated from automated test coverage analysis against `test-requirements.md`.

**Coverage Status:** PASS â€” All 12 automated acceptance criteria covered by 66 tests.

---

## Prerequisites

- Windows 11 machine with audio output device (speakers or headphones) connected and working
- .NET 8 SDK installed
- At least one Piper ONNX voice model pair (`.onnx` + `.onnx.json`) in the `voices/` directory. The `en_US-amy-medium` model is required as the default voice.
- `espeak-ng-data` directory present at the expected path
- All automated tests passing: `dotnet test tests/SysTTS.Tests/` (66 passed)
- Stream Deck hardware and Elgato software (Phase 6 only)
- A second machine on the same network (AC6.2 only, or use a phone on the same WiFi)

---

## Phase 1: Service Host and System Tray

| Step | Action | Expected |
|------|--------|----------|
| 1.1 | Open a terminal. Run `dotnet run --project src/SysTTS/SysTTS.csproj` | Application starts without errors. Console output shows Kestrel listening on `http://127.0.0.1:5100`. |
| 1.2 | Look at the Windows system tray (bottom-right notification area, may need to expand with the "^" arrow). | A SysTTS icon is visible in the system tray. |
| 1.3 | Open a browser or terminal and run: `curl http://localhost:5100/api/status` | Response is HTTP 200 with JSON body: `{"running":true,"activeVoices":<number>,"queueDepth":0}` |
| 1.4 | Right-click the SysTTS tray icon. | A context menu appears with at least "SysTTS - Running" (grayed out / informational) and "Quit". |
| 1.5 | Click "Quit" from the context menu. | Application exits cleanly. The tray icon disappears. |
| 1.6 | Verify no orphan processes: run `powershell -Command "Get-Process -Name SysTTS -ErrorAction SilentlyContinue"` | No processes returned (empty output). |
| 1.7 | Run `curl http://localhost:5100/api/status` | Connection refused / failure (server is no longer running). |
| 1.8 | Start SysTTS (step 1.1). Then open a second terminal and run `dotnet run --project src/SysTTS/SysTTS.csproj` | The second instance shows an error dialog or log message containing "Failed to start HTTP server on port 5100" (or similar port-in-use error). The second instance exits after acknowledging the error. |
| 1.9 | Stop the first instance via tray "Quit" before continuing. | Clean exit confirmed. |

---

## Phase 2: Voice Manager (operational verification)

| Step | Action | Expected |
|------|--------|----------|
| 2.1 | Start SysTTS. Run `curl http://localhost:5100/api/voices` | HTTP 200 with a JSON array listing all voice models found in the `voices/` directory. Each entry includes an `id` and `sampleRate`. Confirm at minimum `en_US-amy-medium` is listed. |
| 2.2 | While SysTTS is running, copy a new `.onnx` + `.onnx.json` pair into the `voices/` directory. Wait 2 seconds. Run `curl http://localhost:5100/api/voices` again. | The new voice appears in the list without restarting the service. |
| 2.3 | Remove the newly added voice files from `voices/`. Wait 2 seconds. Run `curl http://localhost:5100/api/voices` again. | The removed voice is no longer in the list. |

---

## Phase 3: Speech Endpoint (audio verification)

| Step | Action | Expected |
|------|--------|----------|
| 3.1 | Start SysTTS. Run: `curl -X POST http://localhost:5100/api/speak -H "Content-Type: application/json" -d "{\"text\":\"Hello, this is a test of the text to speech system.\",\"source\":\"default\"}"` | HTTP 202 response. Within 1-2 seconds, audible speech plays through the default audio device. |
| 3.2 | Run: `curl -X POST http://localhost:5100/api/speak -H "Content-Type: application/json" -d "{\"text\":\"This uses a different voice.\",\"source\":\"default\",\"voice\":\"en_US-amy-medium\"}"` | HTTP 202 response. Speech plays using the specified voice. |
| 3.3 | Run a speak request with a long text (several paragraphs). While speech is playing, immediately run: `curl -X POST http://localhost:5100/api/stop` | Speech stops immediately (mid-word or mid-sentence). Silence follows. |
| 3.4 | Run: `curl -X POST http://localhost:5100/api/speak -H "Content-Type: application/json" -d "{\"source\":\"default\"}"` (missing `text` field) | HTTP 400 response with JSON body: `{"error":"text is required"}` |
| 3.5 | Run: `curl -X POST http://localhost:5100/api/speak -H "Content-Type: application/json" -d "{\"text\":\"random unrelated stuff\",\"source\":\"t-tracker\"}"` | HTTP 202 response but NO audible speech (text does not match t-tracker filters). |
| 3.6 | Run: `curl -X POST http://localhost:5100/api/speak -H "Content-Type: application/json" -d "{\"text\":\"Train approaching station\",\"source\":\"t-tracker\"}"` | HTTP 202 response. Audible speech plays using the t-tracker configured voice. |

---

## Phase 4: Global Hotkeys

| Step | Action | Expected |
|------|--------|----------|
| 4.1 | Start SysTTS. Open Notepad. Type "The quick brown fox jumps over the lazy dog." and select all the text (Ctrl+A). Press F23. | Selected text is spoken aloud using the `en_US-amy-medium` voice. |
| 4.2 | Copy "original clipboard content" to clipboard (type it in Notepad, select, Ctrl+C). Now select different text ("Some other text"). Press F23. After speech finishes, open a new Notepad and press Ctrl+V. | The pasted content is "original clipboard content" (clipboard preserved). |
| 4.3 | Click in an empty area so nothing is selected. Press F23. | Nothing happens: no speech, no error dialog, no crash. |
| 4.4 | Open VS Code. Select some text. Press F23. | The selected text from VS Code is spoken aloud (cross-application). |
| 4.5 | Open a web browser. Select text on a webpage. Press F23. | The selected text from the browser is spoken aloud. |

---

## Phase 5: Voice Picker Popup

| Step | Action | Expected |
|------|--------|----------|
| 5.1 | Start SysTTS. Select text in any application. Press F22. | A voice picker popup appears near the mouse cursor with available voices listed. |
| 5.2 | In the picker, double-click on a voice (or select and press Enter). | The popup closes. The selected text is spoken with the chosen voice. |
| 5.3 | Select text again. Press F22. | The picker appears with the previously chosen voice pre-selected. |
| 5.4 | With the picker open, press Escape. | The popup closes. No speech plays. |
| 5.5 | Select text, press F22. Click somewhere outside the popup. | The popup closes. No speech plays. |
| 5.6 | Select text, press F22, choose a non-default voice. Close SysTTS. Restart. Select text, press F22. | After restart, the picker opens with the previously chosen voice pre-selected. |

---

## Phase 6: Speak-Selection Endpoint and Stream Deck

| Step | Action | Expected |
|------|--------|----------|
| 6.1 | Start SysTTS. Select text in any application. Run: `curl -X POST http://localhost:5100/api/speak-selection -H "Content-Type: application/json" -d "{}"` | HTTP 202 response. The currently selected text is spoken aloud. |
| 6.2 | Select different text. Run: `curl -X POST http://localhost:5100/api/speak-selection -H "Content-Type: application/json" -d "{\"voice\":\"en_US-amy-medium\"}"` | HTTP 202 response. The selected text is spoken using the specified voice. |
| 6.3 | (Requires Stream Deck) Build plugin: `cd streamdeck-plugin && npm run build`. Install: `streamdeck link com.systts.sdPlugin`. Open Stream Deck app. | "SysTTS" category appears in the action list. |
| 6.4 | Drag "Speak Selected Text" to a button. Open settings. | Voice dropdown is populated from `/api/voices`. |
| 6.5 | Select text. Press the configured Stream Deck button. | Selected text is spoken aloud. |
| 6.6 | Drag "Speak Custom Text" to a button. Configure text. Press the button. | The configured text is spoken. |
| 6.7 | Drag "Stop Speaking" to a button. Start long speech. Press stop button. | Speech stops immediately. |

---

## End-to-End: Multi-Source Priority and Interruption

1. Start SysTTS.
2. POST a long text as source "default" (priority 3).
3. While speech is playing, immediately POST as source "t-tracker" (priority 1): `"Train approaching North Station"`
4. **Expected:** Default speech is interrupted. T-tracker text is spoken immediately. After t-tracker finishes, silence (interrupted speech not resumed).

---

## End-to-End: Hotkey-to-HTTP Pipeline

1. Start SysTTS. Open Notepad. Type and select: "Integration test from keyboard to speaker."
2. Press F23 (direct-mode hotkey).
3. **Expected:** Text spoken within 1-2 seconds.
4. Immediately Ctrl+V in a new location.
5. **Expected:** Clipboard content is the pre-capture state, not the selected text.

---

## End-to-End: Voice Hot-Reload During Active Session

1. Start SysTTS. Run `curl http://localhost:5100/api/voices` and note the count.
2. Drop a new voice model pair into `voices/`. Wait 2 seconds.
3. Run `curl http://localhost:5100/api/voices`.
4. **Expected:** New voice appears.
5. POST speech using the new voice.
6. **Expected:** Speech plays using the new voice model.

---

## Security: Localhost-Only Binding (AC6.2)

1. Start SysTTS. Confirm no Windows Firewall prompt appeared.
2. From a second machine on the same network, run `curl http://<this-machine-ip>:5100/api/status`.
3. **Expected:** Connection refused (not timeout, not a response).
4. Confirm in `src/SysTTS/Program.cs` that Kestrel is configured with `http://127.0.0.1:{port}`.

---

## Traceability

| Acceptance Criterion | Automated Test | Manual Step |
|----------------------|----------------|-------------|
| sys-tts.AC1.1 | -- | Phase 1: 1.1-1.3 |
| sys-tts.AC1.2 | -- | Phase 1: 1.4 |
| sys-tts.AC1.3 | -- | Phase 1: 1.5-1.7 |
| sys-tts.AC1.4 | -- | Phase 1: 1.8 |
| sys-tts.AC2.1 | SpeechServiceTests | Phase 3: 3.1 |
| sys-tts.AC2.2 | SpeechServiceTests | Phase 3: 3.2 |
| sys-tts.AC2.3 | SpeechServiceTests (2 tests) | Phase 3: 3.5, 3.6 |
| sys-tts.AC2.4 | SpeechServiceTests | Phase 3: 3.1 |
| sys-tts.AC2.5 | SpeechQueueTests | Phase 3: 3.3 |
| sys-tts.AC2.6 | -- | Phase 3: 3.4 |
| sys-tts.AC2.7 | SpeechQueueTests | E2E: Priority |
| sys-tts.AC2.8 | SpeechQueueTests | -- |
| sys-tts.AC3.1 | VirtualKeyParserTests | Phase 4: 4.1, 4.4, 4.5 |
| sys-tts.AC3.2 | -- | Phase 5: 5.1 |
| sys-tts.AC3.3 | -- | Phase 5: 5.2 |
| sys-tts.AC3.4 | -- | Phase 4: 4.2 |
| sys-tts.AC3.5 | UserPreferencesTests | Phase 5: 5.6 |
| sys-tts.AC3.6 | -- | Phase 5: 5.4-5.5 |
| sys-tts.AC3.7 | -- | Phase 4: 4.3 |
| sys-tts.AC3.8 | SpeakSelectionEndpointTests | Phase 6: 6.1-6.2 |
| sys-tts.AC4.1 | VoiceManagerTests | Phase 2: 2.1 |
| sys-tts.AC4.2 | VoiceManagerTests | Phase 2: 2.2 |
| sys-tts.AC4.3 | TtsEngineTests | -- |
| sys-tts.AC4.4 | VoiceManagerTests | -- |
| sys-tts.AC4.5 | VoiceManagerTests | -- |
| sys-tts.AC5.* | Deferred (T-Tracker PR) | Deferred |
| sys-tts.AC6.1 | SpeechQueueTests | -- |
| sys-tts.AC6.2 | -- | Security section |
| sys-tts.AC6.3 | -- | Phase 6: 6.3-6.7 |
